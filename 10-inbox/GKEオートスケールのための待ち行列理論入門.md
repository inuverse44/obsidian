---
template: Inbox
title: GKEオートスケールのための待ち行列理論入門
date: 2025-07-08
source: ソースを入れてください
tags:
  - GKE
  - 待ち行列
  - GCP
status: pending
priority: 高
aliases:
---
# GKEオートスケールのための待ち行列理論入門：M/M/cモデルの基礎

GKE (Google Kubernetes Engine) のオートスケーリング、特にHPA (Horizontal Pod Autoscaler) の最適なパラメータ設定は、多くのエンジニアにとって悩みの種です。ここでは、その最適値を「勘と経験」ではなく、数学的な根拠に基づいて導出するための第一歩として、**待ち行列理論**のM/M/cモデルの基礎を解説します。

---

## 1. M/M/cモデルとは？

M/M/cモデルは、システムの振る舞いを分析するための基本的な待ち行列モデルです。GKEの文脈では以下のように対応します。

-   **M (Markovian Arrival Process)**: リクエストの**到着**がランダム（**ポアソン分布**）に従う。
-   **M (Markovian Service Process)**: Podでの**処理時間**がランダム（**指数分布**）に従う。
-   **c**: 処理を行うサーバー、すなわち**Podの数**。

### 1.1. なぜ到着は「ポアソン分布」なのか？

Webへのリクエストは、不特定多数のユーザーから独立かつランダムに発生します。このような「多数の、独立した、稀な事象の積み重ね」は、確率分布である**ポアソン分布**で非常によくモデル化できます。

単位時間あたりの平均到着数を $\lambda$ とすると、その時間内に実際に $k$ 件のリクエストが到着する確率 $P(k)$ は以下の式で与えられます。


$$P(k) = \frac{\lambda^k e^{-\lambda}}{k!}$$


### 1.2. なぜ処理時間は「指数分布」なのか？

Podが行う多くの処理は、過去の履歴に依存しません。あるリクエストの処理にこれまでどれだけ時間がかかったとしても、残りの処理時間は変わりません。この「**無記憶性 (Memoryless Property)**」を持つ確率分布が**指数分布**です。

1Podが単位時間あたりに処理できる平均リクエスト数を $\mu$（サービス率）とすると、あるリクエストの処理時間が $t$ である確率密度 $f(t)$ は以下の式で与えられます。

$$f(t) = \mu e^{-\mu t}$$

### 1.3. システム全体のサービス率 $\mu_n$

システム内に $n$ 個のリクエストがあるときの、**システム全体**でのサービス率は $\mu_n$ と表され、Pod数 `c` を境に変化します。

-   **$n < c$ のとき**: $n$ 個のPodが並列で稼働できるため、システム全体のサービス能力は $n$ 倍になります。
$$\mu_n = n\mu$$
-   **$n \geq c$ のとき**: $c$ 個すべてのPodが稼働しているため、サービス能力は $c$ 倍で頭打ちになります。
$$\mu_n = c\mu$$
これは、個々のリクエストのルーティングを追うミクロな視点ではなく、システム全体のスループットをマクロに捉えた、強力で妥当なモデル化です。
## 2. システムの安定状態：「定常状態」

個々のリクエストは絶えず出入りしますが、システムが十分に安定すると、系内のリクエスト数の確率分布は時間によらず一定になります。この状態を**定常状態**と呼びます。

定常状態では、ある状態 `n` への**確率的な流入量**と、そこからの**流出量**が完全に釣り合っています。これは物理学における流れの保存則 `∇ ⋅ J = 0` (発散ゼロ) と全く同じ概念です。

この釣り合いは、隣り合う状態間では以下の**詳細釣り合いの式**としてシンプルに表現できます。

$$\lambda P_{n-1} = \mu_n P_n$$

ここで、$P_n$ は定常状態において、システム内に $n$ 個のリクエストが存在する確率です。この式は、コーヒーショップの例で言えば「新たに来店して3人になる流れの速さ」と「店員が接客を終えて3人から2人になる流れの速さ」が等しいことを意味します。

---

## 3. GKE性能指標の導出

詳細釣り合いの式と、「全ての確率の和は1になる ($\sum P_n = 1$)」という基本原理から、GKEの性能を予測するための数式を導出できます。

### Step 1: 定常確率 $P_n$ の導出

すべての状態確率 $P_n$ は、システムが完全に空である確率 $P_0$ を基準に、以下のように表現できます。

-   **$n < c$ の場合**:
$$P_n = \frac{1}{n!} \left( \frac{\lambda}{\mu} \right)^n P_0$$
-   **$n \ge c$ の場合**:

$$P_n = \frac{1}{c!} \left( \frac{\lambda}{\mu} \right)^c \left( \frac{\lambda}{c\mu} \right)^{n-c} P_0$$

### Step 2: アイドル確率 $P_0$ の導出

上記の $P_n$ を $\sum_{n=0}^{\infty} P_n = 1$ に代入し、$P_0$ について解くと、以下の公式が得られます。

$$P_0 = \left[ \sum_{n=0}^{c-1} \frac{1}{n!} \left( \frac{\lambda}{\mu} \right)^n + \frac{1}{c!} \left( \frac{\lambda}{\mu} \right)^c \frac{c\mu}{c\mu - \lambda} \right]^{-1}$$

この式は、システムの安定条件である $\lambda < c\mu$ (到着率 < 最大処理能力) のときのみ意味を持ちます。

### Step 3: 主要な性能指標の計算

$P_n$ が分かれば、SLO設計に不可欠な指標を計算できます。

-   **平均待ち行列長 ($L_q$)**: 処理を待っているリクエストの平均数。
$$L_q = \sum_{n=c}^{\infty} (n-c) P_n$$
-   **平均待ち時間 ($W_q$)**: リクエストが待たされる平均時間。これは、**リトルの法則 ($L_q = \lambda W_q$)** を使うことで、$L_q$ から直接計算できます。
$$W_q = \frac{L_q}{\lambda}$$
-   **システム全体の平均滞在時間 ($W$)**: リクエストが到着してから処理が完了するまでの総時間。

$$W = W_q + \frac{1}{\mu} \quad (\text{平均待ち時間 + 平均処理時間})$$
## まとめ

我々は今、GKEのようなシステムを分析するための数学的な武器を手に入れました。次のステップは、これらの公式を使い、具体的なビジネス要件（SLO）から「Pod数はいくつにすべきか？」という問いに答えるためのシミュレーションを行っていきます。